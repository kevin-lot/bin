#!/usr/bin/env bash

set -o xtrace -o errexit

# don't cd before the line below
SCRIPT_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )

MATCH_SEMVER_1='s/.*v([^v].+)".*/\1/' # match when semver starts with the letter "v"
MATCH_SEMVER_2='s/.*"([^"].+)".*/\1/' # match when semver doesn't have the letter "v"

# find os
case "$(uname -s)" in
  Darwin*) OS='macos';;
  Linux*)  OS='linux';;
  *)       echo "unsupported os"; exit 1;;
esac
case "$(uname -m)" in
  arm64)   ARCH='arm64' ;;
  armv7l)  ARCH='arm' ;;
  x86_64)  ARCH='x64' ;;
  *)       echo "Unsupported architecture"; exit 1 ;;
esac

draw_spacer() { echo "+++++++++ +++++++++ +++++++++ +++++++++"; echo; echo; }

install_awscli() {
    if [[ ${OS} == 'macos' ]]; then
        brew install awscli
        return
    fi

    echo "+++++++++ awscli install +++++++++"
    if [[ ${OS} == 'linux' ]]; then
        (
            cd "${SCRIPT_DIR}" || exit 1

            VERSION=$(aws --version 2>/dev/null)
            SUFFIX_COMMAND=""
            if [[ -n "${VERSION}" ]]; then SUFFIX_COMMAND="--update"; fi
            rm -rf awscliv2.zip &>/dev/null
            rm -rf tmp &>/dev/null
            curl -fLSs https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip -o awscliv2.zip
            unzip -qq awscliv2.zip -d tmp
            ./tmp/aws/install --bin-dir "${HOME}/bin" --install-dir "${HOME}/.aws/aws-cli" ${SUFFIX_COMMAND}
            rm -rf awscliv2.zip &>/dev/null
            rm -rf tmp &>/dev/null
        )
    fi
}
install_circleci() {
    echo "+++++++++ circleci install +++++++++"
    (
        curl -fLSs https://raw.githubusercontent.com/CircleCI-Public/circleci-cli/master/install.sh | DESTDIR="${HOME}/bin" bash
    )
}
install_lazygit() {
    echo "+++++++++ lazygit install +++++++++"
    (
        cd "${SCRIPT_DIR}" || exit 1

        LAZYGIT_VERSION=$(curl -fLSs https://api.github.com/repos/jesseduffield/lazygit/releases/latest | grep '"tag_name":' | sed -E "$MATCH_SEMVER_1")
        rm -rf lazygit &>/dev/null
        if [[ ${OS} == 'macos' ]]; then
            curl -fLSs "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Darwin_arm64.tar.gz" -o lazygit.tar.gz
        else
            curl -fLSs "https://github.com/jesseduffield/lazygit/releases/download/v${LAZYGIT_VERSION}/lazygit_${LAZYGIT_VERSION}_Linux_x86_64.tar.gz" -o lazygit.tar.gz
        fi
        tar xzf lazygit.tar.gz lazygit
        chmod a+x lazygit
        rm -f lazygit.tar.gz &>/dev/null
    )
}
install_fvm() {
    echo "+++++++++ fvm install +++++++++"
    (
        cd "${SCRIPT_DIR}" || exit 1

        FVM_VERSION=$(curl -fLSs https://api.github.com/repos/leoafarias/fvm/releases/latest | grep '"tag_name":' | sed -E "$MATCH_SEMVER_2")
        rm -rf fvm &>/dev/null
        rm -rf "${HOME}/.fvm" &>/dev/null
        if [[ ${OS} == 'macos' ]]; then
            curl -fLSs "https://github.com/leoafarias/fvm/releases/download/${FVM_VERSION}/fvm-${FVM_VERSION}-macos-arm64.tar.gz" -o fvm.tar.gz
        else
            curl -fLSs "https://github.com/leoafarias/fvm/releases/download/${FVM_VERSION}/fvm-${FVM_VERSION}-linux-x64.tar.gz" -o fvm.tar.gz
        fi
        tar xzf fvm.tar.gz
        mv fvm "${HOME}/.fvm"
        rm -rf fvm.tar.gz &>/dev/null
        ln -s "${HOME}/.fvm/fvm" fvm
        mkdir -p "${HOME}/.fvm/cache"
    )

    cat <<"EOF"
    [[ -d "$HOME/.fvm/cache" ]] && export FVM_CACHE_PATH="$HOME/.fvm/cache"
    [[ -d "$HOME/.fvm/cache/default/bin" ]] && export PATH="$HOME/.fvm/cache/default/bin:$PATH"
    [[ -d "$HOME/.pub-cache/bin" ]] && export PATH="$HOME/.pub-cache/bin:$PATH"
    [[ -f "$HOME/.dart-cli-completion/fvm.zsh" ]] && source "$HOME/.dart-cli-completion/fvm.zsh"
    alias dart="fvm dart"
    alias flutter="fvm flutter"
EOF
}
install_mise() {
    echo "+++++++++ mise install +++++++++"
    (
        cd "${SCRIPT_DIR}" || exit 1

        if [[ ${OS} == 'macos' ]]; then
            curl https://mise.jdx.dev/mise-latest-macos-arm64 > ./mise
        else
            curl https://mise.jdx.dev/mise-latest-linux-x64 > ./mise
        fi
        chmod +x ./mise
    )

    cat <<"EOF"
    eval "$(""${HOME}/bin/mise"" activate zsh)"
    eval "$(""${HOME}/bin/mise"" hook-env -s zsh)"
EOF
}
install_terraform_docs() {
    echo "+++++++++ terraform docs install +++++++++"
    (
        cd "${SCRIPT_DIR}" || exit 1

        TERRAFORM_DOCS_VERSION=$(curl -fLSs https://api.github.com/repos/terraform-docs/terraform-docs/releases/latest | grep '"tag_name":' | sed -E "$MATCH_SEMVER_2")
        rm -rf terraform-docs &>/dev/null
        if [[ ${OS} == 'macos' ]]; then
            curl -fLSs "https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-darwin-arm64.tar.gz" -o terraform-docs.tar.gz
        else
            curl -fLSs "https://github.com/terraform-docs/terraform-docs/releases/download/${TERRAFORM_DOCS_VERSION}/terraform-docs-${TERRAFORM_DOCS_VERSION}-linux-amd64.tar.gz" -o terraform-docs.tar.gz
        fi
        tar xzf terraform-docs.tar.gz terraform-docs
        chmod +x terraform-docs
        rm -rf terraform-docs.tar.gz &>/dev/null
    )
}
install_terragrunt() {
    echo "+++++++++ terragrunt install +++++++++"
    (
        cd "${SCRIPT_DIR}" || exit 1

        TERRAGRUNT_VERSION=$(curl -fLSs https://api.github.com/repos/gruntwork-io/terragrunt/releases/latest | grep '"tag_name":' | sed -E "$MATCH_SEMVER_2")
        rm -rf terragrunt &>/dev/null
        if [[ ${OS} == 'macos' ]]; then
            curl -fLSs "https://github.com/gruntwork-io/terragrunt/releases/download/${TERRAGRUNT_VERSION}/terragrunt_darwin_arm64" -o terragrunt
        else
            curl -fLSs "https://github.com/gruntwork-io/terragrunt/releases/download/${TERRAGRUNT_VERSION}/terragrunt_linux_amd64" -o terragrunt
        fi
        chmod a+x terragrunt
    )

    cat <<"EOF"
    [[ -d "$TERRAGRUNT_PATH" ]] && complete -o nospace -C "$TERRAGRUNT_PATH" terragrunt
EOF
}
install_tflint() {
    if [[ ${OS} == 'macos' ]]; then
        brew install tflint
        return
    fi

    echo "+++++++++ tflint install +++++++++"
    curl -fLSs https://raw.githubusercontent.com/terraform-linters/tflint/master/install_linux.sh | TFLINT_INSTALL_PATH="${HOME}/bin" bash
}
install_tfswitch() {
    if [[ ${OS} == 'macos' ]]; then
        brew install warrensbox/tap/tfswitch
        return
    fi

    echo "+++++++++ tfswitch install +++++++++"
    curl -fLSs https://raw.githubusercontent.com/warrensbox/terraform-switcher/release/install.sh | BINDIR="${HOME}/bin" bash
}
install_omz_plugins() {
    echo "+++++++++ ohmyzsh plugins install +++++++++"
    if [[ ! -d "${HOME}/.oh-my-zsh" ]]; then exit 1; fi

    local PLUGINS_PATH="${HOME}/.oh-my-zsh/custom/plugins"

    rm -rf "${PLUGINS_PATH}/zsh-autosuggestions" &>/dev/null
    git clone https://github.com/zsh-users/zsh-autosuggestions.git "${PLUGINS_PATH}/zsh-autosuggestions"

    rm -rf "${PLUGINS_PATH}/zsh-syntax-highlighting" &>/dev/null
    git clone https://github.com/zsh-users/zsh-syntax-highlighting.git "${PLUGINS_PATH}/zsh-syntax-highlighting"

    rm -rf "${PLUGINS_PATH}/zsh-completions" &>/dev/null
    git clone --depth=1 https://github.com/zsh-users/zsh-completions "${PLUGINS_PATH}/zsh-completions"
}
install_omz_theme() {
    echo "+++++++++ ohmyzsh theme install +++++++++"
    if [[ ! -d "${HOME}/.oh-my-zsh" ]]; then exit 1; fi

    local THEMES_PATH="${HOME}/.oh-my-zsh/custom/themes"
    rm -rf "${THEMES_PATH}/powerlevel10k" &>/dev/null
    git clone --depth=1 https://github.com/romkatv/powerlevel10k.git "${THEMES_PATH}/powerlevel10k"

    cat <<"EOF"
    ZSH_THEME="powerlevel10k/powerlevel10k"
EOF
}

# install packages on linux
if [[ "${OS}" == 'linux' ]]; then
    echo "+++++++++ install apt packages +++++++++"
    apt update
    apt install --yes \
        btop \
        build-essential \
        dconf-editor \
        git \
        gparted \
        gradle \
        jq \
        kazam \
        ncdu \
        neovim  \
        ngrok \
        nmap \
        pipx \
        rpi-imager \
        scrcpy \
        terminator \
        traceroute \
        xmlstarlet
fi
if [[ ${OS} == 'macos' ]]; then
    # install brew on macos
    if ! command -v brew &>/dev/null; then
        echo "+++++++++ install brew +++++++++"
        curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh | bash

        echo "relaunch the terminal then the script";
        exit 1;
    fi

    brew update
    brew install \
        btop \
        gnupg \
        jq \
        libpq \
        ncdu \
        neovim \
        ngrok/ngrok/ngrok \
        nmap \
        pinentry-mac \
        pipx \
        scrcpy \
        xmlstarlet

    brew link --force libpq
fi

draw_spacer
command -v git &>/dev/null || { echo "need git"; exit 1; }

install_awscli
install_circleci
install_fvm
install_lazygit
install_mise
install_omz_plugins
install_omz_theme
install_terraform_docs
install_terragrunt
install_tflint
install_tfswitch

draw_spacer

pipx ensurepath
pipx list
pipx upgrade-all
! command -v awslocal &>/dev/null && pipx install awscli-local
! command -v aws-mfa &>/dev/null && pipx install aws-mfa
! command -v jp.py &>/dev/null && pipx install jmespath
! command -v yamllint &>/dev/null && pipx install yamllint
